name: Daily DNS Formats Update

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches:
      - main
    paths:
      - 'list.json'
      - '.github/workflows/daily_dns_formats.yml'

jobs:
  update:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required for pushing changes
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for proper git operations
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install required packages if needed
          # pip install requests dnspython
          
      - name: Run DNS format update script
        run: |
          # Create scripts directory if it doesn't exist
          mkdir -p scripts
          
          # Create the update script inline
          cat > scripts/update_dns_formats.py << 'EOF'
#!/usr/bin/env python3
import json
import os
from pathlib import Path
from datetime import datetime

# Configuration
BASE_DIR = Path(os.getcwd())
LIST_FILE = BASE_DIR / "list.json"
DNS_DIR = BASE_DIR / "dns"
COMMUNITY_DIR = BASE_DIR / "community"

# Create directories if they don't exist
DNS_DIR.mkdir(exist_ok=True)
COMMUNITY_DIR.mkdir(exist_ok=True)

def load_domains():
    """Load domains from list.json"""
    try:
        with open(LIST_FILE, 'r', encoding='utf-8') as f:
            data = json.load(f)
            if isinstance(data, list):
                return data
            elif isinstance(data, dict) and 'domains' in data:
                return data['domains']
            return []
    except:
        return []

def clean_domain(domain):
    """Clean domain from extra characters"""
    if not domain:
        return None
    domain = str(domain).strip().lower()
    # Remove protocol
    for proto in ['https://', 'http://', 'ftp://']:
        if domain.startswith(proto):
            domain = domain[len(proto):]
    # Remove path
    domain = domain.split('/')[0]
    domain = domain.split('?')[0]
    # Basic validation
    if not domain or '.' not in domain:
        return None
    return domain

def save_json(data, filepath):
    """Save data to JSON file"""
    with open(filepath, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2, ensure_ascii=False)

def save_text_list(domains, filepath):
    """Save domains to text file"""
    with open(filepath, 'w', encoding='utf-8') as f:
        for domain in domains:
            f.write(domain + '\n')

def save_hosts_format(domains, filepath):
    """Save in hosts file format"""
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write("# PhishDestroy blocklist - hosts format\n")
        f.write(f"# Updated: {datetime.utcnow().isoformat()}\n")
        f.write(f"# Domains: {len(domains)}\n\n")
        for domain in domains:
            f.write(f"0.0.0.0 {domain}\n")

def save_adblock_format(domains, filepath):
    """Save in AdBlock format"""
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write("[Adblock Plus 2.0]\n")
        f.write("! Title: PhishDestroy Blocklist\n")
        f.write(f"! Updated: {datetime.utcnow().isoformat()}\n")
        f.write(f"! Domains: {len(domains)}\n\n")
        for domain in domains:
            f.write(f"||{domain}^\n")

# Main execution
print("Starting DNS formats update...")
raw_domains = load_domains()
print(f"Loaded {len(raw_domains)} domains")

# Clean domains
domains = []
for domain in raw_domains:
    cleaned = clean_domain(domain)
    if cleaned and cleaned not in domains:
        domains.append(cleaned)

domains.sort()
print(f"Cleaned to {len(domains)} unique domains")

# Save formats
save_json(domains, DNS_DIR / "active_domains.json")
save_text_list(domains, DNS_DIR / "domains.txt")
save_hosts_format(domains, DNS_DIR / "hosts.txt")
save_adblock_format(domains, DNS_DIR / "adblock.txt")

# Community formats
community_data = {
    "domains": domains,
    "count": len(domains),
    "updated": datetime.utcnow().isoformat(),
    "source": "PhishDestroy"
}
save_json(community_data, COMMUNITY_DIR / "blocklist.json")
save_json(community_data, COMMUNITY_DIR / "live_blocklist.json")

print("Update completed successfully!")
EOF
          
          # Run the script
          python scripts/update_dns_formats.py
          
      - name: Check for changes
        id: verify-changed-files
        run: |
          if git diff --quiet; then
            echo "No changes detected"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit and push if changed
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "Update DNS formats and active domains [skip ci]" || exit 0
          git push origin main