name: Update Statistics
on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

jobs:
  stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Calculate statistics
        run: |
          python3 << 'EOF'
          import json
          import subprocess
          import os
          from datetime import datetime, timedelta
          
          def get_count(file):
              try:
                  with open(file, 'r') as f:
                      data = json.load(f)
                      return len(data) if isinstance(data, list) else 0
              except:
                  return 0
          
          def get_git_count(file, days_ago):
              """Get domain count from git history"""
              since = (datetime.now() - timedelta(days=days_ago)).strftime('%Y-%m-%d')
              cmd = f'git show HEAD@{{{days_ago} day ago}}:{file} 2>/dev/null | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0"'
              result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
              return int(result.stdout.strip() or "0")
          
          current_primary = get_count('list.json')
          current_community = get_count('community/blocklist.json')
          
          yesterday_primary = get_git_count('list.json', 1)
          week_ago_primary = get_git_count('list.json', 7)
          
          yesterday_community = get_git_count('community/blocklist.json', 1)
          week_ago_community = get_git_count('community/blocklist.json', 7)
          
          today_added = max(0, current_primary - yesterday_primary)
          week_added = max(0, current_primary - week_ago_primary)
          
          today_community = max(0, current_community - yesterday_community)
          week_community = max(0, current_community - week_ago_community)
          
          os.makedirs('dns', exist_ok=True)
          
          def create_badge(label, value, color="blue"):
              return {
                  "schemaVersion": 1,
                  "label": label,
                  "message": f"+{value:,}",
                  "color": color
              }
          
          with open('dns/today_added.json', 'w') as f:
              json.dump(create_badge("added today", today_added, "success"), f, indent=2)
          
          with open('dns/week_added.json', 'w') as f:
              json.dump(create_badge("added this week", week_added, "success"), f, indent=2)
          
          with open('dns/today_community.json', 'w') as f:
              json.dump(create_badge("community today", today_community, "blue"), f, indent=2)
          
          with open('dns/week_community.json', 'w') as f:
              json.dump(create_badge("community this week", week_community, "blue"), f, indent=2)
          
          print(f"Today: +{today_added} primary, +{today_community} community")
          print(f"Week: +{week_added} primary, +{week_community} community")
          EOF

      - name: Commit statistics
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add dns/*.json
          git diff --cached --quiet || git commit -m "Update daily statistics"
          git push
